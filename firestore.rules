rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function restaurantDoc(restaurantId) {
      return get(/databases/$(database)/documents/restaurants/$(restaurantId));
    }

    function isRestaurantPublic(restaurantId) {
      return restaurantDoc(restaurantId).data.isPublic == true;
    }

    function isOwnerOfRestaurant(restaurantId) {
      return isSignedIn() && (request.auth.uid in restaurantDoc(restaurantId).data.owners);
    }

    // restaurants
    match /restaurants/{restaurantId} {
      // Use resource.data so queries evaluate per-doc without extra get()
      allow read: if resource.data.isPublic == true || (isSignedIn() && (request.auth.uid in resource.data.owners));
      // Allow create if the creator includes themself as owner
      allow create: if isSignedIn()
        && request.resource.data.owners != null
        && (request.auth.uid in request.resource.data.owners)
        && request.resource.data.keys().hasOnly(['name','slug','isPublic','owners','phone','address','website','hours','theme','socialMedia','logo','subscriptionPlan','subscriptionStatus','subscriptionStartDate','subscriptionEndDate','createdAt','updatedAt']);
      allow update, delete: if isOwnerOfRestaurant(restaurantId);
    }

    // menus: require a restaurantId field
    match /menus/{menuId} {
      allow read: if isRestaurantPublic(resource.data.restaurantId) || isOwnerOfRestaurant(resource.data.restaurantId);
      allow create: if isOwnerOfRestaurant(request.resource.data.restaurantId)
        && request.resource.data.keys().hasOnly(['restaurantId','title','type','description','active','deleted','order','createdAt','updatedAt']);
      allow update, delete: if isOwnerOfRestaurant(resource.data.restaurantId);
    }

    // categories: link to menu via menuId
    match /categories/{categoryId} {
      function menuDoc(menuId) { return get(/databases/$(database)/documents/menus/$(menuId)); }
      function catRestaurantIdFromExisting() { return menuDoc(resource.data.menuId).data.restaurantId; }
      function catRestaurantIdFromNew() { return menuDoc(request.resource.data.menuId).data.restaurantId; }

      allow read: if isRestaurantPublic(catRestaurantIdFromExisting()) || isOwnerOfRestaurant(catRestaurantIdFromExisting());
      allow create: if isOwnerOfRestaurant(catRestaurantIdFromNew());
      allow update, delete: if isOwnerOfRestaurant(catRestaurantIdFromExisting());
    }

    // items: link to category via categoryId -> menu -> restaurant
    match /items/{itemId} {
      function categoryDoc(categoryId) { return get(/databases/$(database)/documents/categories/$(categoryId)); }
      function menuDoc(menuId) { return get(/databases/$(database)/documents/menus/$(menuId)); }
      function itemRestaurantIdFromExisting() { return menuDoc(categoryDoc(resource.data.categoryId).data.menuId).data.restaurantId; }
      function itemRestaurantIdFromNew() { return menuDoc(categoryDoc(request.resource.data.categoryId).data.menuId).data.restaurantId; }

      allow read: if isRestaurantPublic(itemRestaurantIdFromExisting()) || isOwnerOfRestaurant(itemRestaurantIdFromExisting());
      allow create: if isOwnerOfRestaurant(itemRestaurantIdFromNew());
      allow update, delete: if isOwnerOfRestaurant(itemRestaurantIdFromExisting());
    }

    // analyticsEvents: public write for tracking, owner read
    match /analyticsEvents/{eventId} {
      allow read: if isOwnerOfRestaurant(resource.data.restaurantId);
      allow create: if request.resource.data.keys().hasOnly(['type','restaurantId','menuId','userAgent','timestamp','sessionId','createdAt']);
    }

    // analyticsStats: owner read/write for aggregated statistics
    match /analyticsStats/{statsId} {
      allow read: if isSignedIn() && (
        // Allow reading stats that start with restaurant_ + restaurantId
        statsId.matches('restaurant_.*') && isOwnerOfRestaurant(statsId.split('restaurant_')[1])
        ||
        // Allow reading stats that start with menu_ + restaurantId
        statsId.matches('menu_.*') && isOwnerOfRestaurant(statsId.split('menu_')[1].split('_')[0])
        ||
        // Allow reading stats that start with views_ + restaurantId  
        statsId.matches('views_.*') && isOwnerOfRestaurant(statsId.split('views_')[1].split('_')[0])
      );
      allow write: if isSignedIn() && request.resource.data.restaurantId != null && isOwnerOfRestaurant(request.resource.data.restaurantId);
    }
  }
}